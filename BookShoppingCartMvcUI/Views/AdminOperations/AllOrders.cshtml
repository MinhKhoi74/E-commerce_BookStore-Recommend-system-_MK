@model IEnumerable<Order>
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "AllOrders";
}

<div class="container-fluid mt-4">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary">📦 Danh sách đơn hàng</h3>
    </div>

    <!-- 🔍 SEARCH + FILTER FORM -->
    <form method="get" class="d-flex flex-nowrap gap-2 mb-4 align-items-start">

        <!-- Tìm kiếm -->
        <input type="text" name="search" value="@ViewBag.Search"
               class="form-control"
               placeholder="Tìm theo tên / email / số điện thoại..."
               style="min-width: 200px;" />

        <!-- Thanh toán -->
        <select class="form-select" name="paymentStatus" style="min-width: 150px;">
            <option value="">-- Thanh toán --</option>
            <option value="paid" selected="@(ViewBag.PaymentStatus == "paid" ? "selected" : null)">Đã thanh toán</option>
            <option value="unpaid" selected="@(ViewBag.PaymentStatus == "unpaid" ? "selected" : null)">Chưa thanh toán</option>
        </select>

        <!-- Trạng thái đơn hàng -->
        <select class="form-select" name="orderStatus" style="min-width: 150px;">
            <option value="">-- Trạng thái đơn hàng --</option>
            @foreach (var status in ViewBag.OrderStatuses)
            {
                <option value="@status.Id" selected="@(ViewBag.OrderStatus == status.Id ? "selected" : null)">
                    @status.StatusName
                </option>
            }
        </select>

        <!-- Nút Lọc & Làm mới -->
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-success" style="width:100px;height:45px">Lọc</button>
            <a href="@Url.Action("AllOrders")" class="btn btn-warning" style="width:100px;height:45px;align-items:center;color:white">Làm mới</a>
        </div>

    </form>



    <!-- 🔶 TABLE -->
    @if (Model != null && Model.Any())
    {
        <div class="card shadow-sm border-0">
            <div class="card-body p-0">

                <table class="table table-striped table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Ngày đặt</th>
                            <th>Tên khách</th>
                            <th>SĐT</th>
                            <th>Email</th>
                            <th>Địa chỉ</th>
                            <th>Thanh toán</th>
                            <th>Trạng thái</th>
                            <th style="width: 250px;">Thao tác</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var order in Model)
                        {
                            <tr>
                                <td>@order.CreateDate.ToString("dd-MM-yyyy")</td>
                                <td>@order.Name</td>
                                <td>@order.MobileNumber</td>
                                <td>@order.Email</td>
                                <td>@order.Address</td>

                                <td>
                                    <span class="badge @(order.IsPaid ? "bg-success" : "bg-danger")">
                                        @(order.IsPaid ? "Đã thanh toán" : "Chưa thanh toán")
                                    </span>
                                    <br />
                                    <small>@order.PaymentMethod</small>
                                </td>

                                <td>
                                    <span class="badge bg-info text-dark">@order.OrderStatus.StatusName</span>
                                </td>

                                <td>
                                    <div class="d-flex flex-column gap-2">

                                        <!-- Chi tiết -->
                                        <button type="button"
                                                class="btn btn-primary btn-sm w-100"
                                                data-bs-toggle="modal"
                                                data-bs-target="#modal-@order.Id">
                                            Chi tiết đơn hàng
                                        </button>

                                        <!-- Sửa trạng thái -->
                                        <a class="btn btn-warning btn-sm w-100"
                                           asp-action="UpdateOrderStatus"
                                           asp-route-orderId="@order.Id">
                                            Sửa trạng thái
                                        </a>

                                        <!-- Sửa thanh toán -->
                                        <a class="btn btn-secondary btn-sm w-100"
                                           asp-action="TogglePaymentStatus"
                                           asp-route-orderId="@order.Id">
                                            Sửa thanh toán
                                        </a>
                                    </div>

                                    <!-- Modal Chi tiết -->
                                    @await Html.PartialAsync("/Views/AdminOperations/_OrderDetailModal.cshtml",
                                             new OrderDetailModalDTO
                            {
                                DivId = order.Id.ToString(),
                                OrderDetail = order.OrderDetail
                            })
                                </td>
                            </tr>
                        }
                    </tbody>

                </table>

            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning mt-3">Không có đơn hàng nào.</div>
    }

    <!-- 🔽 PAGINATION -->
    @if (ViewBag.TotalPages > 1)
    {
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">

                <!-- PREV -->
                <li class="page-item @(ViewBag.Page == 1 ? "disabled" : "")">
                    <a class="page-link"
                       href="?page=@(ViewBag.Page - 1)&search=@ViewBag.Search&paymentStatus=@ViewBag.PaymentStatus&orderStatus=@ViewBag.OrderStatus">
                        Trước
                    </a>
                </li>

                <!-- NUMBERS -->
                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                {
                    <li class="page-item @(i == ViewBag.Page ? "active" : "")">
                        <a class="page-link"
                           href="?page=@i&search=@ViewBag.Search&paymentStatus=@ViewBag.PaymentStatus&orderStatus=@ViewBag.OrderStatus">
                            @i
                        </a>
                    </li>
                }

                <!-- NEXT -->
                <li class="page-item @(ViewBag.Page == ViewBag.TotalPages ? "disabled" : "")">
                    <a class="page-link"
                       href="?page=@(ViewBag.Page + 1)&search=@ViewBag.Search&paymentStatus=@ViewBag.PaymentStatus&orderStatus=@ViewBag.OrderStatus">
                        Sau
                    </a>
                </li>

            </ul>
        </nav>
    }

</div>
