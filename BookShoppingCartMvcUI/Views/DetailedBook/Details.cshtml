@model BookShoppingCartMvcUI.Models.Book
@using BookShoppingCartMvcUI.Models.DTOs
@{
    Layout = "_Layout";
    ViewData["Title"] = Model.BookName;
}

<!-- Google Fonts: Poppins cho tiêu đề, Roboto cho nội dung -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@400;500&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" rel="stylesheet" />

<style>
    body {
        background-color: #f5f5f5;
        font-family: 'Roboto', sans-serif;
        color: #333;
    }

    .card-custom {
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        padding: 20px;
        margin-bottom: 20px;
        font-family: 'Roboto', sans-serif;
    }

    .product-image {
        width: 100%;
        border-radius: 12px;
        object-fit: contain;
        max-height: 400px;
        transition: transform 0.3s;
    }
    .product-image:hover { transform: scale(1.02); }

    .btn-rounded {
        border-radius: 12px;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
    }

    .thumbnail-img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #ccc;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .thumbnail-img:hover { transform: scale(1.1); }

    .book-info {
        background-color: #fff8f5;
        border: 2px solid #ff6b3d;
        padding: 20px;
        font-family: 'Montserrat', sans-serif;
    }
    .book-info h3 {
        font-family: 'Poppins', sans-serif;
        font-weight: 700;
        font-size: 1.9rem;
        color: #222;
        margin-bottom: 10px;
    }
    .book-info p {
        font-family: 'Roboto', sans-serif;
        font-weight: 500;
        margin-bottom: 6px;
    }
    .book-info .fs-3 {
        font-family: 'Poppins', sans-serif;
        font-weight: 700;
        color: #d63333;
    }

    .desc-container {
        font-family: 'Roboto', sans-serif;
        font-weight: 400;
        line-height: 1.6;
        overflow: hidden;
        transition: max-height 0.4s ease;
    }
    #toggleDesc {
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        color: #ff6b3d;
        cursor: pointer;
    }

    .recommendation-section {
        background: linear-gradient(to right, #2c3e50, #16a085);
        color: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-family: 'Roboto', sans-serif;
    }
    .recommendation-header {
        background: rgba(255,255,255,0.15);
        color: white;
        border-radius: 15px;
        padding: 8px 12px;
        margin-bottom: 15px;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
    }

    .swiper-slide {
        transition: transform 0.2s ease-in-out;
    }
    .swiper-slide:hover {
        transform: translateY(-5px);
    }

    @@media (max-width:768px){
        .thumbnail-img { width:48px; height:48px; }
        .form-control[type="number"]{ width:60px !important; }
    }
</style>

<div class="container py-4">
    <div class="row gx-4">
        <!-- Left: Image + buttons -->
        <div class="col-md-5">
            <div class="position-sticky" style="top:20px;">
                <div class="card card-custom text-center">
                    <img src="~/images/@Model.Image" class="product-image mb-3" alt="@Model.BookName" />
                    <div class="d-flex justify-content-center align-items-center gap-2 mb-3 flex-wrap">
                        <label class="mb-0">Số lượng:</label>
                        <input id="qtyInput" type="number" value="1" min="1" class="form-control w-auto" style="width:70px;">
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-danger btn-rounded" onclick="addToCart(@Model.Id, false)">
                            <i class="bi bi-cart-plus me-1"></i> Thêm vào giỏ hàng
                        </button>
                        <button class="btn btn-danger btn-rounded" onclick="addToCart(@Model.Id, true)">
                            Mua ngay
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Info -->
        <div class="col-md-7">
            <div class="card book-info mb-3">
                <h3 class="fw-bold mb-2">@Model.BookName</h3>
                <p class="mb-1"><strong>Tác giả:</strong> @Model.AuthorName</p>
                <p class="mb-1"><strong>Thể loại:</strong> @Model.Genre?.GenreName</p>
                <div class="fs-3 fw-bold text-danger">@Model.Price.ToString("N0") VNĐ</div>
            </div>

            <div class="card card-custom mb-3">
                <h4 class="mb-2">Mô tả sản phẩm</h4>
                <div id="descContainer" class="desc-container" style="max-height:150px;">
                    @Html.Raw(Model.Description)
                </div>
                <button class="btn btn-link p-0 mt-2" id="toggleDesc">Xem thêm</button>
            </div>
        </div>
    </div>
</div>

<!-- UserCF Recommendations -->
@if (ViewBag.UserCFRecommendations != null)
{
    @await Html.PartialAsync(
        "~/Views/Shared/Partials/_Recommendation.cshtml",
        (IEnumerable<BookDTO>)ViewBag.UserCFRecommendations,
        new ViewDataDictionary(ViewData) { { "SectionTitle", "Có thể bạn sẽ thích" } }
    )
}

<!-- ItemCF Recommendations -->
@if (ViewBag.ItemCFRecommendations != null)
{
    @await Html.PartialAsync(
        "~/Views/Shared/Partials/_Recommendation.cshtml",
        (IEnumerable<BookDTO>)ViewBag.ItemCFRecommendations,
        new ViewDataDictionary(ViewData) { { "SectionTitle", "Sách liên quan" } }
    )
}

<!-- Related Books -->
@await Html.PartialAsync(
    "~/Views/Shared/Partials/_RelatedBooksSection.cshtml",
    (BooksByGenreSectionModel)ViewBag.RelatedBooks
)

<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
<script src="~/js/index.js"></script>

@section Scripts {
<script>
    // Mở rộng / Thu gọn mô tả sách
    const toggleBtn = document.getElementById('toggleDesc');
    const descContainer = document.getElementById('descContainer');

    toggleBtn.addEventListener('click', () => {
        if(descContainer.style.maxHeight && descContainer.style.maxHeight !== '150px'){
            descContainer.style.maxHeight = '150px';
            toggleBtn.innerText = 'Xem thêm';
        } else {
            descContainer.style.maxHeight = descContainer.scrollHeight + 'px';
            toggleBtn.innerText = 'Thu gọn';
        }
    });

    async function addToCart(bookId, isBuyNow) {
        var qty = parseInt(document.getElementById("qtyInput").value) || 1;
        if (!document.getElementById("username")) {
            window.location.href = "/Identity/Account/Login";
            return;
        }
        try {
            let url = `/Cart/AddItem?bookId=${bookId}&qty=${qty}&redirect=${isBuyNow ? 1 : 0}`;
            let response = await fetch(url);
            if (isBuyNow) {
                window.location.href = "/Cart/GetUserCart";
            } else if (response.status == 200) {
                let result = await response.json();
                document.getElementById("cartCount").innerHTML = result;
                alert("Đã thêm vào giỏ hàng!");
            }
        } catch (err) {
            console.error("Error adding to cart:", err);
        }
    }
</script>
}
